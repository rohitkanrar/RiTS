# Risk-inclusive Contextual Bandits for Early Phase Clinical Trials

This repository contains all codes used in the following paper

- Kanrar, R., Li, C., Ghodsi, Z., Gamalo, M. (2025+). Risk-inclusive Contextual Bandits for Early Phase Clinical Trials.

The method is named **R**isk-**i**nclusive **T**hompson **S**ampling (RiTS).

## Contents

- `/code/function`: contains all the supporting functions developed to conduct empirical experiments.
- `/code/real_data`: contains scripts to clean, visualize and analyze the real data utilized in the article.
- `/code/simulation`: contains scripts to conduct all simulation experiments described in both the main manuscript and the supplementary material. 
- `/code/visualization`: contains scripts that generates all figures except Figure 1 and Figure 2 in the main manuscript.
- `/metadata`: Additional .RData files created to run the simulation experiments conveniently. Files contain lists to specify hyper-parameters required in the simulation experiments.

### Contents of `/code/function`:
- `/code/function/main_function.R`: contains major functions to implement `Rand`, `TS` and `RiTS`.
- `/code/function/misc.R`: contains functions to clip propensities, obtain cumulative miscoverage, etc. 
- `/code/function/asymp_cs.R`: contains all functions to evaluate AsympCS.
- `/code/function/classical_ci.R`: contains functions to add t-test based confidence intervals to simulation outputs. 

### Contents of `/code/real_data`:
- `/code/real_data/replicated_application`: contains all functions to replicate methods on generated pseudo-outcomes.
- `/code/real_data/clean.R`: used to clean the data (not important as the real data is not shared.) 
- `/code/real_data/eda.R`: used to perform initial exploratory data analysis to select relevant covariates.
- `/code/real_data/baseline_lab.R`: supports the inclusion of some bio-markers in the safety model.

### Contents of `/code/simulation`:
- `/code/simulation/replicated_trial.R`: execute trial optimization steps with all methods for all choices of hyper-parameters. Multiple cores execute different cases in parallel.
- `/code/simulation/replicated_trial_evaluation.R`: adds AsympCSs and T-test based confidence intervals to the output generated by `/code/simulation/replicated_trial.R`.

### Contents of `/code/visualization`:
- `/code/visualization/appendix_viz.R`: generates all plots in the Web Appendix.
- `/code/visualization/main_viz.R`: generates all plots in the main text.
- `/code/visualization/viz_functions.R`: includes all functions to generate plots.
- `/code/visualization/response_letter.R`: used to generate a line plot included in the response letter.
- `/code/visualization/main_tab.R`: generates all tables included in the main text.
- `/code/visualization/appendix_tab.R`: generates all tables included in the Web Appendix.


## Initial Setup:

- Clone Github Repository:
Option 1 (Full Repository):

```
git clone git@github.com:rohitkanrar/RiTS.git
cd RiTS
```
Option 2 (Without Plots, Tables and Example Output Files):

```
GIT_LFS_SKIP_SMUDGE=1 git clone git@github.com:rohitkanrar/RiTS.git
cd RiTS
```

To Fetch All LFS Files Later:
```
git lfs pull
```

To Fetch A Specific LFS Files Later:
```
git lfs pull
git lfs pull --include="path/to/your/large_file"
```

- Create additional folders to save output files:

```
mkdir output
mkdir plot
```

- Install all required R packages:

```
source("code/r/requirements.R")
```

## To Replicate Results:

- Please follow `simulation_example.Rmd` to reproduce all experiments, figures and tables.
- To replicate all simulation experiments, follow the steps below:
```
mkdir output
Rscript code/simulation/replicated_trial.R
Rscript code/simulation/replicated_trial_evaluation.R
```
- To generate plots and tables: 
```
mkdir plot
mkdir tables
Rscript code/visualization/main_viz.R
Rscript code/visualization/main_tab.R
Rscript code/visualization/appendix_viz.R
Rscript code/visualization/appendix_tab.R
```
- We are unable to upload all output files (> 8.3 GB) on GitHub. Please execute the code above to generate original output files. 
- With 16 CPU cores, it took us around 12 hours to complete all simulation.
- Neither the real data nor the output can be provided due to privacy concerns.


## References

[1] Waudby-Smith, I., Arbour, D., Sinha, R., Kennedy, E. H., and Ramdas, A. (2024). Time-
uniform central limit theory and asymptotic confidence sequences. The Annals of Statistics,
52(6):2613â€“2640.

Open-sourced software: drconfseq is implemented in [https://github.com/WannabeSmith/drconfseq](https://github.com/WannabeSmith/drconfseq).

**I would like to thank the authors of the above open-sourced software.**

## Additional Acknowledgement
I would like to thank [Professor Somak Dutta](https://faculty.sites.iastate.edu/somakd/) for providing access to his personal High-performance Computing cluster, which greatly helped an efficient execution of this project.
